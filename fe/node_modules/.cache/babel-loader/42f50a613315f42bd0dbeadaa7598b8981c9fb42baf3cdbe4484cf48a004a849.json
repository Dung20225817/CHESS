{"ast":null,"code":"import{useEffect,useRef,useState}from\"react\";export function useChessSocket(roomId,onUpdate){const ws=useRef(null);const[playerColor,setPlayerColor]=useState(null);const onUpdateRef=useRef(onUpdate);// ‚úÖ C·∫≠p nh·∫≠t callback m·ªói khi onUpdate thay ƒë·ªïi, nh∆∞ng KH√îNG kh·ªüi t·∫°o l·∫°i WS\nuseEffect(()=>{onUpdateRef.current=onUpdate;},[onUpdate]);// ‚úÖ Ch·ªâ kh·ªüi t·∫°o websocket 1 l·∫ßn duy nh·∫•t (khi roomId ƒë·ªïi)\nuseEffect(()=>{ws.current=new WebSocket(\"ws://localhost:8765\");ws.current.onopen=()=>{var _ws$current;(_ws$current=ws.current)===null||_ws$current===void 0?void 0:_ws$current.send(JSON.stringify({type:\"join\",room:roomId}));};ws.current.onmessage=event=>{const data=JSON.parse(event.data);switch(data.type){case\"assignColor\":setPlayerColor(data.color);break;case\"state\":{const fen=data.fen;const turn=data.turn;const gameOver=data.gameOver||null;const evt=data.event||undefined;// üß© nh·∫≠n event t·ª´ server\nonUpdateRef.current(fen,turn,gameOver,evt);break;}case\"error\":alert(data.msg);break;default:console.warn(\"Unknown message type:\",data.type);}};ws.current.onclose=()=>{console.log(\"Disconnected from server\");};return()=>{var _ws$current2;(_ws$current2=ws.current)===null||_ws$current2===void 0?void 0:_ws$current2.close();};},[roomId]);// ‚úÖ ch·ªâ reconnect khi roomId thay ƒë·ªïi\nconst sendMove=moveUCI=>{var _ws$current3;if(((_ws$current3=ws.current)===null||_ws$current3===void 0?void 0:_ws$current3.readyState)===WebSocket.OPEN){ws.current.send(JSON.stringify({type:\"move\",move:moveUCI,room:roomId}));}else{console.warn(\"‚ö†Ô∏è WebSocket is not open. Cannot send move.\");}};return{sendMove,playerColor};}","map":{"version":3,"names":["useEffect","useRef","useState","useChessSocket","roomId","onUpdate","ws","playerColor","setPlayerColor","onUpdateRef","current","WebSocket","onopen","_ws$current","send","JSON","stringify","type","room","onmessage","event","data","parse","color","fen","turn","gameOver","evt","undefined","alert","msg","console","warn","onclose","log","_ws$current2","close","sendMove","moveUCI","_ws$current3","readyState","OPEN","move"],"sources":["C:/Users/User/PycharmProjects/Chess/fe/src/components/useChessSocket.ts"],"sourcesContent":["import { useEffect, useRef, useState } from \"react\";\n\nexport function useChessSocket(\n  roomId: string,\n  onUpdate: (fen: string, turn: \"white\" | \"black\", gameOver: null | \"white\" | \"black\", event?: string) => void,\n) {\n  const ws = useRef<WebSocket | null>(null);\n  const [playerColor, setPlayerColor] = useState<\"white\" | \"black\" | null>(null);\n  const onUpdateRef = useRef(onUpdate);\n\n  // ‚úÖ C·∫≠p nh·∫≠t callback m·ªói khi onUpdate thay ƒë·ªïi, nh∆∞ng KH√îNG kh·ªüi t·∫°o l·∫°i WS\n  useEffect(() => {\n    onUpdateRef.current = onUpdate;\n  }, [onUpdate]);\n\n  // ‚úÖ Ch·ªâ kh·ªüi t·∫°o websocket 1 l·∫ßn duy nh·∫•t (khi roomId ƒë·ªïi)\n  useEffect(() => {\n    ws.current = new WebSocket(\"ws://localhost:8765\");\n\n    ws.current.onopen = () => {\n      ws.current?.send(JSON.stringify({ type: \"join\", room: roomId }));\n    };\n\n    ws.current.onmessage = (event) => {\n      const data = JSON.parse(event.data);\n\n      switch (data.type) {\n        case \"assignColor\":\n          setPlayerColor(data.color);\n          break;\n\n        case \"state\":\n          {\n            const fen = data.fen;\n            const turn = data.turn;\n            const gameOver = data.gameOver || null;\n            const evt = data.event || undefined; // üß© nh·∫≠n event t·ª´ server\n            onUpdateRef.current(fen, turn, gameOver, evt);\n            break;\n          }\n\n        case \"error\":\n          alert(data.msg);\n          break;\n\n        default:\n          console.warn(\"Unknown message type:\", data.type);\n      }\n    };\n\n    ws.current.onclose = () => {\n      console.log(\"Disconnected from server\");\n    };\n\n    return () => {\n      ws.current?.close();\n    };\n  }, [roomId]); // ‚úÖ ch·ªâ reconnect khi roomId thay ƒë·ªïi\n\n  const sendMove = (moveUCI: string) => {\n    if (ws.current?.readyState === WebSocket.OPEN) {\n      ws.current.send(JSON.stringify({ type: \"move\", move: moveUCI, room: roomId }));\n    }\n    else {\n      console.warn(\"‚ö†Ô∏è WebSocket is not open. Cannot send move.\");\n    }\n  };\n\n  return { sendMove, playerColor };\n}\n"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}